#include<reg51.h>
#include<intrins.h>

sbit SRCLK=P3^6;
sbit RCLK=P3^5;
sbit SER=P3^4;

#define COMMONPORTS     P0

unsigned char flag = 0;
unsigned char revD;	

unsigned char code TAB[8]  = {0x7f,0xbf,0xdf,0xef,0xf7,0xfb,0xfd,0xfe};

unsigned char code CHARCODE[36][8]=
{

{0x00,0x7E,0xFF,0xC3,0xC3,0xFF,0x7E,0x00}, //0

{0x00,0x63,0x63,0xFF,0xFF,0x03,0x03,0x00}, //1

{0x00,0x9F,0x9F,0x99,0x99,0x99,0xF9,0x00}, //2

{0x00,0xC3,0x99,0x99,0x99,0x99,0xFF,0x00}, //3

{0x00,0x38,0x68,0xC8,0xFF,0xFF,0x08,0x00}, //4

{0x00,0xF3,0xF1,0xD1,0xD1,0xD1,0xDF,0x00}, //5
	
{0x00,0x7E,0x91,0x91,0x91,0x91,0x4E,0x00}, //6
	
{0x00,0x80,0x80,0x80,0x80,0xFF,0xFF,0x00}, //7
	
{0x00,0x6E,0x91,0x91,0x91,0x91,0x6E,0x00}, //8
	
{0x00,0x72,0x99,0x99,0x99,0x99,0x7E,0x00}, //9
	
{0x00,0x3F,0x7F,0xE4,0xE4,0x7F,0x3F,0x00}, //A
	
{0x00,0xFF,0x91,0x91,0x91,0x91,0x6E,0x00}, //B
	
{0x00,0x7E,0x81,0x81,0x81,0x81,0x66,0x00}, //C
	
{0x00,0xFF,0xFF,0x81,0x81,0x81,0x7E,0x00}, //D
	
{0x00,0xFF,0xFF,0x93,0x93,0x93,0x93,0x00}, //E
	
{0x00,0xFF,0xFF,0xD0,0xD0,0xD0,0xC0,0x00}, //F
	
{0x00,0x7E,0x83,0x8B,0x8B,0x8B,0x4E,0x00}, //G
	
{0x00,0xFF,0xFF,0x18,0x18,0xFF,0xFF,0x00}, //H
	
{0x00,0x00,0x81,0xFF,0xFF,0x81,0x00,0x00}, //I
	
{0x00,0x00,0x02,0x81,0xFF,0xFE,0x80,0x00}, //J
	
{0x00,0xFF,0xFF,0x1C,0x26,0x43,0x81,0x00}, //K
	
{0x00,0xFF,0xFF,0x03,0x03,0x03,0x07,0x00}, //L
	
{0x00,0xFF,0x40,0x20,0x20,0x40,0xFF,0x00}, //M
	
{0x00,0xFF,0x80,0x40,0x20,0x10,0xFF,0x00}, //N
	
{0x00,0x7E,0xFF,0xC3,0xC3,0xFF,0x7E,0x00}, //O
	
{0x00,0xFF,0xFF,0x88,0x88,0x88,0x70,0x00}, //P
	
{0x00,0x7E,0x81,0x85,0x85,0x7E,0x01,0x00}, //Q
	
{0x00,0xFF,0xFF,0x98,0x94,0x92,0x61,0x00}, //R
	
{0x00,0x62,0x91,0x91,0x89,0x89,0x46,0x00}, //S
	
{0x00,0xC0,0xC0,0xFF,0xFF,0xC0,0xC0,0x00}, //T
	
{0x00,0xFE,0xFF,0x03,0x03,0xFF,0xFE,0x00}, //U
	
{0x00,0xFC,0x02,0x01,0x01,0x02,0xFC,0x00}, //V
	
{0x00,0xFF,0x02,0x04,0x04,0x02,0xFF,0x00}, //W

{0x00,0xC3,0x24,0x18,0x18,0x24,0xC3,0x00}, //X
	
{0x00,0xF0,0x08,0x0F,0x0F,0x08,0xF0,0x00}, //Y

{0x00,0x83,0x85,0x89,0x91,0xA1,0xC1,0x00}, //Z

};

void serial_init() {
	//SM0 = 0; SM1 = 1;			//chon UART mode 1
	TMOD = 0x20;					//Timer 1 hoat dong che do 8 
	SCON 	= 0x50;
	TH1 = 0xFD;						//Toc do baud = 9600
	TR1 = 1;							//Chay timer 1
	
	EA = 1;								//Cho phep ngat toan cuc
	ES = 1;								//Cho phep ngat serial
}

void serial_send(unsigned char i) {
	SBUF = i;							//Dat du lieu vao thanh ghi SBUF de truyen
	while(TI == 0);				//Khi TI = 1 thi da truyen thanh cong
	TI = 0;								//Chuan bi cho du lieu truyen tiep theo
}
												//Ham gui chuoi ky tu
void serial_send_str(char * str) {
	unsigned char i = 0;	//Khoi tao ky tu i
	while(str[i] != 0) {	//Khi con ky tu co nghia
		serial_send(str[i]);//Gui ky tu do
		i++;								//Tang vi tri
	}
}
												//Ham ngat - dung de nhan du lieu
void serial_ISR(void) interrupt 4 {
	if(RI == 1) {					//Neu du lieu nhan thanh cong
		revD = SBUF;				//revD = du lieu da nhan
		
		RI = 0;							//Chuan bi cho du lieu nhan tiep theo
		
		flag = 1;						//Cho thay dang co du lieu dc nhan
	}
}

int Change_char_int(unsigned char i) 
{
	if(i >= '0' && i <= '9') return i - '0';
	else if(i >= 'A' && i <='Z') return i - 'A' + 10;
	else if(i >= 'a' && i <= 'z') return i - 'a' + 10;
}


void delay(unsigned int time)
{
  unsigned int i,j;
  for(i=0;i<time;i++)
    for(j=0;j<123;j++);
}
void Hc595SendByte(unsigned char dat)
{
    unsigned char a;
    SRCLK=0;
    RCLK=0;
    for(a=0;a<8;a++)
    {
        SER=dat>>7;
        dat<<=1;

        SRCLK=1;
        _nop_();
        _nop_();
        SRCLK=0;    
    }

    RCLK=1;
    _nop_();
    _nop_();
    RCLK=0;
}

void main()
{  
	unsigned char VITRI[100];
	unsigned int a = 0;
	
	unsigned char tab, j;
  unsigned int  i, m, l;
	
	serial_init();
	
	serial_send_str("Moi nhap : ");
  while(1)
  {   
		if(flag == 1) {
			switch(revD) {
				case '\r':
					for(l = 0; l <= a; l++) {
						VITRI[l] = Change_char_int(VITRI[l]);
					}
					for(m = 0; m < a; m++) {
						for(i= 0; i<63; i++)//
						{
							for(tab=0;tab<8;tab++)
							{   
									j = VITRI[m];
									Hc595SendByte(0x00);                 
									COMMONPORTS = TAB[tab];              
									Hc595SendByte(CHARCODE[j][tab]);    
									delay(1);       
							}
						}
					}
					a = 0;
					serial_send_str("Moi nhap : ");
				break;
				default:
					VITRI[a] = revD;
					a ++;
				break;
			}
			flag = 0;
		}   
	}
}